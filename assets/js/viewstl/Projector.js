THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0,this.renderOrder=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0,this.renderOrder=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null,this.renderOrder=0},THREE.Projector=function(){function e(t){if(!1!==t.visible){if(t instanceof THREE.Light)O.lights.push(t);else if(t instanceof THREE.Mesh||t instanceof THREE.Line||t instanceof THREE.Points){if(!1===t.material.visible)return;if(!0===t.frustumCulled&&!1===G.intersectsObject(t))return;r(t)}else if(t instanceof THREE.Sprite){if(!1===t.material.visible)return;if(!0===t.frustumCulled&&!1===G.intersectsSprite(t))return;r(t)}for(var n=t.children,i=0,o=n.length;i<o;i++)e(n[i])}}function r(e){(p=n()).id=e.id,p.object=e,C.setFromMatrixPosition(e.matrixWorld),C.applyMatrix4(A),p.z=C.z,p.renderOrder=e.renderOrder,O.objects.push(p)}function t(e,r,t){var n=1/e.w;e.z*=n,e.z>=-1&&e.z<=1&&((v=s()).id=r.id,v.x=e.x*n,v.y=e.y*n,v.z=e.z,v.renderOrder=r.renderOrder,v.object=r,v.rotation=r.rotation,v.scale.x=r.scale.x*Math.abs(v.x-(e.x+t.projectionMatrix.elements[0])/(e.w+t.projectionMatrix.elements[12])),v.scale.y=r.scale.y*Math.abs(v.y-(e.y+t.projectionMatrix.elements[5])/(e.w+t.projectionMatrix.elements[13])),v.material=r.material,O.elements.push(v))}function n(){if(E===H){var e=new THREE.RenderableObject;return T.push(e),H++,E++,e}return T[E++]}function i(){if(f===w){var e=new THREE.RenderableVertex;return g.push(e),w++,f++,e}return g[f++]}function o(){if(h===M){var e=new THREE.RenderableFace;return S.push(e),M++,h++,e}return S[h++]}function a(){if(y===z){var e=new THREE.RenderableLine;return b.push(e),z++,y++,e}return b[y++]}function s(){if(x===j){var e=new THREE.RenderableSprite;return V.push(e),j++,x++,e}return V[x++]}function l(e,r){return e.renderOrder!==r.renderOrder?e.renderOrder-r.renderOrder:e.z!==r.z?r.z-e.z:e.id!==r.id?e.id-r.id:0}function c(e,r){var t=0,n=1,i=e.z+e.w,o=r.z+r.w,a=-e.z+e.w,s=-r.z+r.w;return i>=0&&o>=0&&a>=0&&s>=0||!(i<0&&o<0||a<0&&s<0)&&(i<0?t=Math.max(t,i/(i-o)):o<0&&(n=Math.min(n,i/(i-o))),a<0?t=Math.max(t,a/(a-s)):s<0&&(n=Math.min(n,a/(a-s))),!(n<t)&&(e.lerp(r,t),r.lerp(e,1-n),!0))}var p,E,u,f,d,h,m,y,v,x,R,T=[],H=0,g=[],w=0,S=[],M=0,b=[],z=0,V=[],j=0,O={objects:[],lights:[],elements:[]},C=new THREE.Vector3,L=new THREE.Vector4,k=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),B=new THREE.Box3,N=new Array(3),W=new THREE.Matrix4,A=new THREE.Matrix4,F=new THREE.Matrix4,P=new THREE.Matrix3,G=new THREE.Frustum,D=new THREE.Vector4,U=new THREE.Vector4;this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(r)},this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(r)},this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var I=new function(){function e(e){H=(T=e).material,w.getNormalMatrix(T.matrixWorld),y.length=0,v.length=0,x.length=0}function r(e){var r=e.position,t=e.positionWorld,n=e.positionScreen;t.copy(r).applyMatrix4(R),n.copy(t).applyMatrix4(A);var i=1/n.w;n.x*=i,n.y*=i,n.z*=i,e.visible=n.x>=-1&&n.x<=1&&n.y>=-1&&n.y<=1&&n.z>=-1&&n.z<=1}function t(e,t,n){(u=i()).position.set(e,t,n),r(u)}function n(e,r,t){y.push(e,r,t)}function s(e,r,t){v.push(e,r,t)}function l(e,r){x.push(e,r)}function p(e,r,t){return!0===e.visible||!0===r.visible||!0===t.visible||(N[0]=e.positionScreen,N[1]=r.positionScreen,N[2]=t.positionScreen,k.intersectsBox(B.setFromPoints(N)))}function E(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0}function f(e,r){var t=g[e],n=g[r];t.positionScreen.copy(t.position).applyMatrix4(F),n.positionScreen.copy(n.position).applyMatrix4(F),!0===c(t.positionScreen,n.positionScreen)&&(t.positionScreen.multiplyScalar(1/t.positionScreen.w),n.positionScreen.multiplyScalar(1/n.positionScreen.w),(m=a()).id=T.id,m.v1.copy(t),m.v2.copy(n),m.z=Math.max(t.positionScreen.z,n.positionScreen.z),m.renderOrder=T.renderOrder,m.material=T.material,T.material.vertexColors===THREE.VertexColors&&(m.vertexColors[0].fromArray(v,3*e),m.vertexColors[1].fromArray(v,3*r)),O.elements.push(m))}function h(e,r,t){var n=g[e],i=g[r],a=g[t];if(!1!==p(n,i,a)&&(H.side===THREE.DoubleSide||!0===E(n,i,a))){(d=o()).id=T.id,d.v1.copy(n),d.v2.copy(i),d.v3.copy(a),d.z=(n.positionScreen.z+i.positionScreen.z+a.positionScreen.z)/3,d.renderOrder=T.renderOrder,d.normalModel.fromArray(y,3*e),d.normalModel.applyMatrix3(w).normalize();for(var s=0;s<3;s++){var l=d.vertexNormalsModel[s];l.fromArray(y,3*arguments[s]),l.applyMatrix3(w).normalize(),d.uvs[s].fromArray(x,2*arguments[s])}d.vertexNormalsLength=3,d.material=T.material,O.elements.push(d)}}var y=[],v=[],x=[],T=null,H=null,w=new THREE.Matrix3;return{setObject:e,projectVertex:r,checkTriangleVisibility:p,checkBackfaceCulling:E,pushVertex:t,pushNormal:n,pushColor:s,pushUv:l,pushLine:f,pushTriangle:h}};this.projectScene=function(r,n,s,p){h=0,y=0,x=0,O.elements.length=0,!0===r.autoUpdate&&r.updateMatrixWorld(),null===n.parent&&n.updateMatrixWorld(),W.copy(n.matrixWorldInverse),A.multiplyMatrices(n.projectionMatrix,W),G.setFromMatrix(A),E=0,O.objects.length=0,O.lights.length=0,e(r),!0===s&&O.objects.sort(l);for(var u=O.objects,v=0,T=u.length;v<T;v++){var H=u[v].object,w=H.geometry;if(I.setObject(H),R=H.matrixWorld,f=0,H instanceof THREE.Mesh){if(w instanceof THREE.BufferGeometry){var S=w.attributes,M=w.groups;if(S.position===undefined)continue;for(var b=0,z=(Te=S.position.array).length;b<z;b+=3)I.pushVertex(Te[b],Te[b+1],Te[b+2]);if(S.normal!==undefined){var V=S.normal.array;for(b=0,z=V.length;b<z;b+=3)I.pushNormal(V[b],V[b+1],V[b+2])}if(S.uv!==undefined){var j=S.uv.array;for(b=0,z=j.length;b<z;b+=2)I.pushUv(j[b],j[b+1])}if(null!==w.index){var k=w.index.array;if(M.length>0)for(var B=0;B<M.length;B++){var N=M[B];for(b=N.start,z=N.start+N.count;b<z;b+=3)I.pushTriangle(k[b],k[b+1],k[b+2])}else for(b=0,z=k.length;b<z;b+=3)I.pushTriangle(k[b],k[b+1],k[b+2])}else for(b=0,z=Te.length/3;b<z;b+=3)I.pushTriangle(b,b+1,b+2)}else if(w instanceof THREE.Geometry){var q=w.vertices,J=w.faces,K=w.faceVertexUvs[0];P.getNormalMatrix(R);for(var Q=H.material,X=Array.isArray(Q),Y=0,Z=q.length;Y<Z;Y++){var $=q[Y];if(C.copy($),!0===Q.morphTargets)for(var _=w.morphTargets,ee=H.morphTargetInfluences,re=0,te=_.length;re<te;re++){var ne=ee[re];if(0!==ne){var ie=_[re].vertices[Y];C.x+=(ie.x-$.x)*ne,C.y+=(ie.y-$.y)*ne,C.z+=(ie.z-$.z)*ne}}I.pushVertex(C.x,C.y,C.z)}for(var oe=0,ae=J.length;oe<ae;oe++){var se=J[oe];if((Q=!0===X?H.material[se.materialIndex]:H.material)!==undefined){var le=Q.side,ce=g[se.a],pe=g[se.b],Ee=g[se.c];if(!1!==I.checkTriangleVisibility(ce,pe,Ee)){var ue=I.checkBackfaceCulling(ce,pe,Ee);if(le!==THREE.DoubleSide){if(le===THREE.FrontSide&&!1===ue)continue;if(le===THREE.BackSide&&!0===ue)continue}(d=o()).id=H.id,d.v1.copy(ce),d.v2.copy(pe),d.v3.copy(Ee),d.normalModel.copy(se.normal),!1!==ue||le!==THREE.BackSide&&le!==THREE.DoubleSide||d.normalModel.negate(),d.normalModel.applyMatrix3(P).normalize();for(var fe=se.vertexNormals,de=0,he=Math.min(fe.length,3);de<he;de++){var me=d.vertexNormalsModel[de];me.copy(fe[de]),!1!==ue||le!==THREE.BackSide&&le!==THREE.DoubleSide||me.negate(),me.applyMatrix3(P).normalize()}d.vertexNormalsLength=fe.length;var ye=K[oe];if(ye!==undefined)for(var ve=0;ve<3;ve++)d.uvs[ve].copy(ye[ve]);d.color=se.color,d.material=Q,d.z=(ce.positionScreen.z+pe.positionScreen.z+Ee.positionScreen.z)/3,d.renderOrder=H.renderOrder,O.elements.push(d)}}}}}else if(H instanceof THREE.Line){if(F.multiplyMatrices(A,R),w instanceof THREE.BufferGeometry){if((S=w.attributes).position!==undefined){for(b=0,z=(Te=S.position.array).length;b<z;b+=3)I.pushVertex(Te[b],Te[b+1],Te[b+2]);if(S.color!==undefined){var xe=S.color.array;for(b=0,z=xe.length;b<z;b+=3)I.pushColor(xe[b],xe[b+1],xe[b+2])}if(null!==w.index)for(b=0,z=(k=w.index.array).length;b<z;b+=2)I.pushLine(k[b],k[b+1]);else{var Re=H instanceof THREE.LineSegments?2:1;for(b=0,z=Te.length/3-1;b<z;b+=Re)I.pushLine(b,b+1)}}}else if(w instanceof THREE.Geometry){if(0===(q=H.geometry.vertices).length)continue;(ce=i()).positionScreen.copy(q[0]).applyMatrix4(F);for(Re=H instanceof THREE.LineSegments?2:1,Y=1,Z=q.length;Y<Z;Y++)(ce=i()).positionScreen.copy(q[Y]).applyMatrix4(F),(Y+1)%Re>0||(pe=g[f-2],D.copy(ce.positionScreen),U.copy(pe.positionScreen),!0===c(D,U)&&(D.multiplyScalar(1/D.w),U.multiplyScalar(1/U.w),(m=a()).id=H.id,m.v1.positionScreen.copy(D),m.v2.positionScreen.copy(U),m.z=Math.max(D.z,U.z),m.renderOrder=H.renderOrder,m.material=H.material,H.material.vertexColors===THREE.VertexColors&&(m.vertexColors[0].copy(H.geometry.colors[Y]),m.vertexColors[1].copy(H.geometry.colors[Y-1])),O.elements.push(m)))}}else if(H instanceof THREE.Points){if(F.multiplyMatrices(A,R),w instanceof THREE.Geometry)for(Y=0,Z=(q=H.geometry.vertices).length;Y<Z;Y++){$=q[Y];L.set($.x,$.y,$.z,1),L.applyMatrix4(F),t(L,H,n)}else if(w instanceof THREE.BufferGeometry){if((S=w.attributes).position!==undefined){var Te;for(b=0,z=(Te=S.position.array).length;b<z;b+=3)L.set(Te[b],Te[b+1],Te[b+2],1),L.applyMatrix4(F),t(L,H,n)}}}else H instanceof THREE.Sprite&&(L.set(R.elements[12],R.elements[13],R.elements[14],1),L.applyMatrix4(A),t(L,H,n))}return!0===p&&O.elements.sort(l),O}};